<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <link rel="stylesheet" href="css/map.css" />

  <body>
    <canvas id="myCanvas" width="1920" height="1600"></canvas>
    <div id="clubInfo">
      <p>
        <span> 名称：<input class="name" type="text" /></span>
        <span>
          关系:
          <select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:
          <select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select></span
        ><span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select></span
        ><span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /> </span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /> </span>
        <span
          >关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span
        ><span
          >关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select></span
        ><span></span>
      </p>
      <p>
        <span>名称：<input class="name" type="text" /></span>
        <span>
          关系:<select class="rel">
            <option value="0">盟友</option>
            <option value="1">敌对</option>
            <option value="2">中立</option>
            <option value="this">自己</option>
          </select>
        </span>
        <span></span>
      </p>
      <p><button id="setClubInfoBtn">确定</button></p>
    </div>
    <div id="lineInfo"></div>
  </body>
  <script type="text/javascript" src="js/yanChangMap.js"></script>
  <script type="text/javascript" src="js/dragula.js"></script>
  <script>
    (function () {
      // 鼠标按下的点
      let cachePageX = 0,
        cachePageY = 0,
        // 是否拖拽
        dragging = false,
        notrOtherBehaviors = true,
        clubInfoList,
        ycMap = null,
        lineList = null,
        _dragula = null;
      var img = new Image();
      img.onload = () => {
        ycMap = new yanChangMap(
          document.getElementById("myCanvas"),
          "Arrow",
          img
        );

        lineList = ycMap.getLineList();
        init();
      };
      img.src = "img/sourceMaterial.png";

      function setClubInfo() {
        const clubInfo = document.getElementById("clubInfo");
        const nameList = clubInfo.querySelectorAll(".name");
        const relList = clubInfo.querySelectorAll(".rel");
        const resList = [];

        for (let index = 0; index < 20; index++) {
          resList.push({
            name: nameList[index].value,
            rel: relList[index].value,
          });
        }
        ycMap.clubInfoList = resList;
        localStorage.setItem("ClubInfo", JSON.stringify(resList));
        ycMap.draw();
      }

      function getLocalClubInfo() {
        const localClubInfo = localStorage.getItem("ClubInfo");
        if (localClubInfo) {
          ycMap.setClubInfoList(JSON.parse(localClubInfo));
        }
        const clubInfo = document.getElementById("clubInfo");
        const nameList = clubInfo.querySelectorAll(".name");
        const relList = clubInfo.querySelectorAll(".rel");
        clubInfoList = ycMap.getClubInfoList();
        clubInfoList.map((itm, index) => {
          nameList[index].value = itm.name;
          relList[index].value = itm.rel;
        });
      }

      function getMapInfoDraw() {
        fetch("./js/mapInfo.json")
          .then((res) => {
            if (res.status === 200) {
              //json是返回的response提供的一个方法,会把返回的json字符串反序列化成对象,也被包装成一个Promise了
              return res.json();
            } else {
              alert("请求地图数据失败");
            }
          })
          .then((shapes) => {
            ycMap.setShapes(shapes);
            ycMap.draw();
          });
      }

      function onWheel(event) {
        event.preventDefault(); // 防止默认的滚轮行为
        const delta = event.wheelDelta ? event.wheelDelta : -event.detail; // 兼容不同浏览器的滚动值

        // 根据滚轮滚动值来调整缩放比例
        let scaleFactor = ycMap.getScaleFactor();
        if (delta > 0) {
          scaleFactor /= 1.1; // 放大
        } else {
          scaleFactor *= 1.1; // 缩小
        }
        ycMap.setScaleFactor(scaleFactor);
        ycMap.draw();
      }

      // 鼠标点击事件处理
      function handleMouseClick(event) {
        const rect = ycMap.getCanvas().getBoundingClientRect();
        const actineLineIndex = ycMap.getActineLineIndex();
        const point = {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top,
        };
        const target = {
          x: ycMap.getXConvert(point.x),
          y: ycMap.getYConvert(point.y),
        };

        // if (ycMap.lineList.length === 0 || !ycMap.lineList[actineLineIndex]) {
        //   ycMap.lineList.push({
        //     list: [],
        //     color: ycMap.generateRandomBrightColor(),
        //   });
        // }

        lineList[actineLineIndex].list.push(target);
        // 重绘
        ycMap.draw();
      }

      function renewLineInfo() {
        const lineInfo = document.getElementById("lineInfo");
        const lineList = ycMap.getLineList();
        const actineLineIndex = ycMap.getActineLineIndex();
        let htmStr = "";
        lineList.map((line, index) => {
          htmStr += `
                <p onClick="setActive(this,${index})" class="${
            actineLineIndex === index ? "active" : ""
          }">
                    <input type="color" data-i="${index}" onClick="setNotrOtherBehaviors()" value="${
            line.color
          }" onChange="colorInputChange(this,${index})" />
                    <span contentEditable="true">路线${index + 1}</span>
                </p>
              `;
        });
        htmStr += `
              <div class="txtCenter">
                  <div class="addIcon">
                      <span onclick="addLine()">+</span>
                  </div>
              </div>
            `;
        lineInfo.innerHTML = htmStr;
      }

      function colorInputChange(colorInput, index) {
        lineList[index].color = colorInput.value;
        ycMap.draw();
      }

      function setActive(colorInput, index) {
        ycMap.setActineLineIndex(index);
        document.querySelector("#lineInfo .active").classList = [];
        colorInput.classList = ["active"];
      }

      function setNotrOtherBehaviors() {
        notrOtherBehaviors = false;
      }

      window.colorInputChange = colorInputChange;
      window.setActive = setActive;
      window.setNotrOtherBehaviors = setNotrOtherBehaviors;
      window.addLine = () => {
        ycMap.addLine();
        renewLineInfo();
      };
      function init() {
        _dragula = dragula();
        // 添加事件监听器
        ycMap
          .getCanvas()
          .addEventListener("wheel", onWheel, { passive: false });
        ycMap.getCanvas().addEventListener("mousewheel", onWheel, {
          passive: false,
        }); // 兼容不同浏览器

        document
          .getElementById("setClubInfoBtn")
          .addEventListener("click", () => setClubInfo());
        // document.getElementById("addLineBtn").addEventListener("click", () => {

        // });
        // 监听整个文档的contextmenu事件
        ycMap.getCanvas().addEventListener("contextmenu", function (event) {
          // 阻止默认的右键菜单
          event.preventDefault();
        });

        ycMap.getCanvas().addEventListener(
          "mousedown",
          (e) => {
            // 鼠标左键
            if (e.button == 0 && notrOtherBehaviors) {
              const mousedownPageX = e.pageX;
              const mousedownPageY = e.pageY;
              dragging = true;
              cachePageX = e.pageX;
              cachePageY = e.pageY;
              //   let isMove = false;
              function mouseup(e) {
                dragging = false;
                // if (
                //   Math.abs(mousedownPageX - e.pageX) <= 10 ||
                //   Math.abs(mousedownPageY - e.pageY) <= 10
                // ) {
                //   handleMouseClick(e);
                // }

                // if (!isMove) {
                //   handleMouseClick(e);
                // }
                window.removeEventListener("mouseup", mouseup);
                ycMap.getCanvas().removeEventListener("mousemove", mousemove);
                // draw();
              }

              function mousemove(e) {
                if (dragging) {
                  //   isMove = true;
                  ycMap.offsetPageX += e.pageX - cachePageX;
                  ycMap.offsetPageY += e.pageY - cachePageY;
                  cachePageX = e.pageX;
                  cachePageY = e.pageY;
                  ycMap.draw();
                }
              }

              window.addEventListener("mouseup", mouseup, false);
              ycMap.getCanvas().addEventListener("mousemove", mousemove, false);
            } else if (e.button == 2) {
              e.preventDefault();
              const actineLineIndex = ycMap.getActineLineIndex();
              const startPoint = getPoint(e, "Start");
              lineList[actineLineIndex].list.push({
                startPointX: startPoint.x,
                startPointY: startPoint.y,
                endPointX: startPoint.x,
                endPointY: startPoint.y,
              });
              ycMap.draw();

              dragging = true;
              function mousemove(e) {
                if (dragging) {
                  const endPoint = getPoint(e);
                  const list = lineList[actineLineIndex].list;
                  const thisPoint = list[list.length - 1];
                  thisPoint.endPointX = endPoint.x;
                  thisPoint.endPointY = endPoint.y;
                  ycMap.draw();
                }
              }
              function mouseup(e) {
                dragging = false;
                window.removeEventListener("mouseup", mouseup);
                ycMap.getCanvas().removeEventListener("mousemove", mousemove);
              }

              window.addEventListener("mouseup", mouseup, false);
              ycMap.getCanvas().addEventListener("mousemove", mousemove, false);
              console.log("右键");
            } else {
              notrOtherBehaviors = true;
            }
          },
          false
        );

        function getPoint(e) {
          const rect = ycMap.getCanvas().getBoundingClientRect();
          const point = {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top,
          };
          return {
            x: ycMap.getXConvert(point.x),
            y: ycMap.getYConvert(point.y),
          };
        }

        document.addEventListener("keydown", function (event) {
          const actineLineIndex = ycMap.getActineLineIndex();
          if (event.altKey) {
            if (event.key === "z") {
              if (!lineList[actineLineIndex]) return;
              lineList[actineLineIndex].list.pop();
              ycMap.draw();
            }
            if (event.key === "t") {
              if (_dragula.containers.length > 0) {
                _dragula.containers = [];
              } else {
                _dragula.containers.push(document.getElementById("clubInfo"));
                }
              }
            if (event.key === "m") {
              ycMap.downloadCanvasImage('map.jpg')
            }
          }
          // if (event.ctrlKey && event.key === "z") {

          // }else if(){

          // }
        });

        getLocalClubInfo();
        getMapInfoDraw();
        renewLineInfo();
      }
    })(window);
  </script>
</html>
